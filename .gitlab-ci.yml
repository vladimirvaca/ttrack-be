# GitLab CI/CD Pipeline for TTrack Backend
# This pipeline includes code quality checks, multiple test suites, and Docker image building

# Define the stages of the pipeline
stages:
  - validate      # Code quality checks
  - test          # Run tests in parallel
  - build         # Build Docker image
  - publish       # Publish Docker image to registry

# Define default configuration for all jobs
default:
  # Use Gradle with JDK 21
  image: gradle:8.11.1-jdk21-alpine
  # Cache Gradle dependencies across jobs
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper
      - .gradle/caches
  # Set up Gradle before each job
  before_script:
    - export GRADLE_USER_HOME=`pwd`/.gradle
    - chmod +x ./gradlew

# Variables
variables:
  # Disable Gradle daemon for CI (recommended)
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  # Docker image configuration
  DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE
  DOCKER_IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  # Use Docker-in-Docker service
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# =============================================================================
# VALIDATE STAGE - Code Quality Checks
# =============================================================================

checkstyle:
  stage: validate
  script:
    - echo "Running Checkstyle checks..."
    - ./gradlew checkstyleMain checkstyleTest checkstyleIntegrationTest checkstyleE2eTest --no-daemon
  artifacts:
    when: always
    paths:
      - build/reports/checkstyle/
    reports:
      junit: build/reports/checkstyle/*.xml
    expire_in: 1 week
  allow_failure: false
  tags:
    - docker

# =============================================================================
# TEST STAGE - Run all test suites in parallel
# =============================================================================

unit-tests:
  stage: test
  script:
    - echo "Running unit tests..."
    - ./gradlew test --no-daemon
  artifacts:
    when: always
    paths:
      - build/reports/tests/test/
      - build/test-results/test/
    reports:
      junit: build/test-results/test/TEST-*.xml
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  allow_failure: false
  tags:
    - docker

integration-tests:
  stage: test
  # Use Docker-in-Docker for TestContainers
  image: docker:27-dind
  services:
    - docker:27-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    # Install Java and Gradle in DinD image
    - apk add --no-cache openjdk21 wget unzip
    - wget https://services.gradle.org/distributions/gradle-8.11.1-bin.zip -P /tmp
    - unzip -d /opt/gradle /tmp/gradle-*.zip
    - ln -s /opt/gradle/gradle-8.11.1/bin/gradle /usr/bin/gradle
    - export GRADLE_USER_HOME=`pwd`/.gradle
    - chmod +x ./gradlew
  script:
    - echo "Running integration tests..."
    - ./gradlew integrationTest --no-daemon
  artifacts:
    when: always
    paths:
      - build/reports/tests/integrationTest/
      - build/test-results/integrationTest/
    reports:
      junit: build/test-results/integrationTest/TEST-*.xml
    expire_in: 1 week
  allow_failure: false
  tags:
    - docker

e2e-tests:
  stage: test
  # Use Docker-in-Docker for TestContainers
  image: docker:27-dind
  services:
    - docker:27-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    # Install Java and Gradle in DinD image
    - apk add --no-cache openjdk21 wget unzip
    - wget https://services.gradle.org/distributions/gradle-8.11.1-bin.zip -P /tmp
    - unzip -d /opt/gradle /tmp/gradle-*.zip
    - ln -s /opt/gradle/gradle-8.11.1/bin/gradle /usr/bin/gradle
    - export GRADLE_USER_HOME=`pwd`/.gradle
    - chmod +x ./gradlew
  script:
    - echo "Running E2E tests..."
    - ./gradlew e2eTest --no-daemon
  artifacts:
    when: always
    paths:
      - build/reports/tests/e2eTest/
      - build/test-results/e2eTest/
    reports:
      junit: build/test-results/e2eTest/TEST-*.xml
    expire_in: 1 week
  allow_failure: false
  tags:
    - docker

# =============================================================================
# BUILD STAGE - Build Docker Image
# =============================================================================

build-docker-image:
  stage: build
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "Building Docker image..."
  script:
    # Build the Docker image
    - docker build -t $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG .
    - docker build -t $DOCKER_IMAGE_NAME:latest .
    # Save the image as an artifact (optional, for inspection)
    - docker save $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG -o ttrack-be-image.tar
  artifacts:
    paths:
      - ttrack-be-image.tar
    expire_in: 1 day
  only:
    - branches
    - tags
  tags:
    - docker
  needs:
    - job: checkstyle
    - job: unit-tests
    - job: integration-tests
    - job: e2e-tests

# =============================================================================
# PUBLISH STAGE - Publish Docker Image to GitLab Container Registry
# =============================================================================

publish-docker-image:
  stage: publish
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "Publishing Docker image to GitLab Container Registry..."
    # Login to GitLab Container Registry
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    # Load the Docker image from artifact
    - docker load -i ttrack-be-image.tar
    # Push the image with commit SHA tag
    - docker push $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG
    # Push the image with 'latest' tag
    - docker push $DOCKER_IMAGE_NAME:latest
    # Tag with branch name if not main/master
    - |
      if [ "$CI_COMMIT_REF_NAME" != "main" ] && [ "$CI_COMMIT_REF_NAME" != "master" ]; then
        docker tag $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG $DOCKER_IMAGE_NAME:$CI_COMMIT_REF_SLUG
        docker push $DOCKER_IMAGE_NAME:$CI_COMMIT_REF_SLUG
      fi
    # Tag with version if it's a tag
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG $DOCKER_IMAGE_NAME:$CI_COMMIT_TAG
        docker push $DOCKER_IMAGE_NAME:$CI_COMMIT_TAG
      fi
  after_script:
    - docker logout $CI_REGISTRY
  # Manual approval required (thumbs up)
  when: manual
  allow_failure: false
  only:
    - branches
    - tags
  tags:
    - docker
  needs:
    - job: build-docker-image
      artifacts: true
  environment:
    name: registry
    url: $CI_REGISTRY_IMAGE

