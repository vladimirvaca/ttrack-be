# GitHub Actions CI/CD Pipeline for TTrack Backend
# This pipeline includes code quality checks and multiple test suites

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
    # Tags are handled by release.yml to prevent duplicate workflow runs
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # =============================================================================
  # CHECK IF COMMIT HAS A TAG - Skip CI if release.yml will handle it
  # =============================================================================

  check-for-tag:
    name: Check for Tag
    runs-on: ubuntu-latest
    outputs:
      has_tag: ${{ steps.check_tag.outputs.has_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if commit has a version tag
        id: check_tag
        run: |
          # Check if current commit has a tag starting with 'v'
          TAG=$(git tag --points-at HEAD | grep '^v' | head -n 1)
          if [ -n "$TAG" ]; then
            echo "Commit has tag: $TAG - skipping CI pipeline (release.yml will run)"
            echo "has_tag=true" >> $GITHUB_OUTPUT
          else
            echo "No version tag found - running CI pipeline"
            echo "has_tag=false" >> $GITHUB_OUTPUT
          fi

  # =============================================================================
  # RUN TESTS - Uses reusable workflow
  # =============================================================================

  tests:
    name: Tests
    needs: [check-for-tag]
    if: needs.check-for-tag.outputs.has_tag == 'false'
    uses: ./.github/workflows/reusable-tests.yml
    with:
      upload-artifacts: true
      publish-results: true
    permissions:
      contents: read
      checks: write
      pull-requests: write
